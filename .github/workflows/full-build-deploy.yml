name: Full Build and Deploy

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: true

env:
  # Toolchain versions for cache keys
  LEAN_VERSION: "v4.27.0"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ========================================
      # SETUP: Free disk space and checkout repos
      # ========================================
      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.0
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: false

      - name: Checkout SBS-Test
        uses: actions/checkout@v4
        with:
          path: SBS-Test
          fetch-depth: 0

      - name: Checkout SubVerso
        uses: actions/checkout@v4
        with:
          repository: e-vergo/subverso
          path: subverso
          ref: main

      - name: Checkout LeanArchitect
        uses: actions/checkout@v4
        with:
          repository: e-vergo/LeanArchitect
          path: LeanArchitect
          ref: main

      - name: Checkout Dress
        uses: actions/checkout@v4
        with:
          repository: e-vergo/Dress
          path: Dress
          ref: main

      - name: Checkout Runway
        uses: actions/checkout@v4
        with:
          repository: e-vergo/Runway
          path: Runway
          ref: main

      - name: Checkout dress-blueprint-action (for assets)
        uses: actions/checkout@v4
        with:
          repository: e-vergo/dress-blueprint-action
          path: dress-blueprint-action
          ref: main

      # ========================================
      # TOOLCHAIN: Install Lean and LaTeX
      # ========================================
      - name: Install elan
        run: |
          curl -sSfL https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Install Lean toolchain
        working-directory: SBS-Test
        run: |
          source $HOME/.elan/env
          lake --version

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-fonts-recommended texlive-latex-extra texlive-science

      # ========================================
      # CACHE: Restore toolchain and mathlib
      # ========================================
      # NOTE: Toolchain cache disabled - it was restoring old binaries and ignoring code fixes.
      # Each build now compiles from source (~5 min overhead but guarantees correctness).
      # TODO: Re-enable with proper cache invalidation based on source file hashes.
      # - name: Restore toolchain cache
      #   id: toolchain-cache
      #   uses: actions/cache/restore@v4
      #   with:
      #     path: |
      #       subverso/.lake
      #       LeanArchitect/.lake
      #       Dress/.lake
      #       Runway/.lake
      #     key: toolchain-build-${{ runner.os }}-${{ env.LEAN_VERSION }}-${{ hashFiles('SBS-Test/lean-toolchain') }}
      #     restore-keys: |
      #       toolchain-build-${{ runner.os }}-${{ env.LEAN_VERSION }}-
      #       toolchain-build-${{ runner.os }}-

      - name: Restore mathlib cache
        id: mathlib-cache
        uses: actions/cache/restore@v4
        with:
          path: SBS-Test/.lake/packages/mathlib
          key: mathlib-${{ runner.os }}-${{ hashFiles('SBS-Test/lake-manifest.json') }}

      - name: Get mathlib cache
        working-directory: SBS-Test
        run: |
          if [ "${{ steps.mathlib-cache.outputs.cache-hit }}" == "true" ]; then
            echo "Mathlib restored from GitHub Actions cache"
            OLEAN_COUNT=$(find .lake/packages/mathlib -name "*.olean" 2>/dev/null | wc -l)
            echo "Found $OLEAN_COUNT oleans in cache"
          else
            echo "Fetching mathlib cache from server..."
            lake exe cache get || echo "::warning::Server cache unavailable, will build from source"
            OLEAN_COUNT=$(find .lake/packages/mathlib -name "*.olean" 2>/dev/null | wc -l)
            echo "Found $OLEAN_COUNT oleans after cache get"
          fi

      # ========================================
      # BUILD: Toolchain (SubVerso -> LeanArchitect -> Dress -> Runway)
      # ========================================
      - name: Build SubVerso
        working-directory: subverso
        run: |
          echo "Building SubVerso (highlighting extraction)..."
          lake build
          echo "SubVerso build complete"

      - name: Build LeanArchitect
        working-directory: LeanArchitect
        run: |
          echo "Building LeanArchitect (@[blueprint] attribute)..."
          lake build
          echo "LeanArchitect build complete"

      - name: Build Dress
        working-directory: Dress
        run: |
          echo "Building Dress (artifact generation)..."
          lake build
          echo "Dress build complete"

      - name: Build Runway
        working-directory: Runway
        run: |
          echo "Building Runway (site generator)..."
          lake build
          echo "Runway build complete"

      # ========================================
      # BUILD: SBS-Test project with dressed artifacts
      # ========================================
      - name: Build SBS-Test with dressed artifacts
        working-directory: SBS-Test
        run: |
          echo "Building SBS-Test with Dress artifact generation..."
          mkdir -p .lake/build
          echo "1" > .lake/build/.dress
          lake build
          rm -f .lake/build/.dress

          # Verify dressed artifacts were generated
          DRESSED_COUNT=$(find .lake/build/dressed -name "*.html" 2>/dev/null | wc -l)
          echo "Generated $DRESSED_COUNT dressed HTML artifacts"
          if [ "$DRESSED_COUNT" -eq 0 ]; then
            echo "::warning::No dressed artifacts found - check @[blueprint] attributes"
          fi

      - name: Build blueprint facet
        working-directory: SBS-Test
        run: |
          echo "Building blueprint Lake facet..."
          lake build :blueprint
          echo "Blueprint facet complete"

      - name: Generate dependency graph
        working-directory: SBS-Test
        run: |
          echo "Generating dependency graph and manifest..."
          lake env ../Dress/.lake/build/bin/extract_blueprint graph \
            --build .lake/build \
            SBSTest

          # Verify manifest was generated
          if [ -f ".lake/build/dressed/manifest.json" ]; then
            echo "Manifest generated successfully"
          else
            echo "::error::manifest.json not found at .lake/build/dressed/manifest.json"
            exit 1
          fi

      # ========================================
      # SITE GENERATION: Runway build
      # ========================================
      - name: Generate site with Runway
        run: |
          mkdir -p SBS-Test/.lake/build/runway

          # Create CI-compatible runway config with absolute paths
          cat > SBS-Test/runway-ci.json << 'RUNWAY_CONFIG'
          {
            "title": "SBS-Test: Blueprint Feature Demonstration",
            "projectName": "SBSTest",
            "githubUrl": "https://github.com/e-vergo/SBS-Test",
            "baseUrl": "/SBS-Test/",
            "blueprintTexPath": "$WORKSPACE/SBS-Test/blueprint/src/blueprint.tex",
            "assetsDir": "$WORKSPACE/dress-blueprint-action/assets",
            "paperTexPath": "$WORKSPACE/SBS-Test/blueprint/src/paper.tex"
          }
          RUNWAY_CONFIG

          # Replace $WORKSPACE placeholder with actual path
          sed -i "s|\$WORKSPACE|${{ github.workspace }}|g" SBS-Test/runway-ci.json

          echo "Runway config:"
          cat SBS-Test/runway-ci.json

          echo "Running Runway site generator..."
          cd Runway && lake exe runway \
            --build-dir ${{ github.workspace }}/SBS-Test/.lake/build \
            --output ${{ github.workspace }}/SBS-Test/.lake/build/runway \
            build \
            ${{ github.workspace }}/SBS-Test/runway-ci.json

          echo "Site generation complete"

      - name: Generate paper with Runway
        run: |
          echo "Running Runway paper generator..."
          cd Runway && lake exe runway \
            --build-dir ${{ github.workspace }}/SBS-Test/.lake/build \
            --output ${{ github.workspace }}/SBS-Test/.lake/build/runway \
            paper \
            ${{ github.workspace }}/SBS-Test/runway-ci.json

          echo "Paper generation complete"

      - name: Verify site structure
        run: |
          echo "Site structure:"
          ls -la SBS-Test/.lake/build/runway/
          echo ""
          echo "Key files:"
          for f in index.html dep_graph.html paper.html; do
            if [ -f "SBS-Test/.lake/build/runway/$f" ]; then
              echo "  [OK] $f"
            else
              echo "  [MISSING] $f"
            fi
          done
          # Check for paper.pdf (optional, may fail if LaTeX not fully configured)
          if [ -f "SBS-Test/.lake/build/runway/paper.pdf" ]; then
            echo "  [OK] paper.pdf"
          else
            echo "  [OPTIONAL] paper.pdf not generated (LaTeX compilation may have failed)"
          fi
          echo ""
          echo "Directories:"
          for d in assets chapters; do
            if [ -d "SBS-Test/.lake/build/runway/$d" ]; then
              COUNT=$(find "SBS-Test/.lake/build/runway/$d" -type f | wc -l)
              echo "  [OK] $d/ ($COUNT files)"
            else
              echo "  [MISSING] $d/"
            fi
          done

      # ========================================
      # CACHE: Save for future builds
      # ========================================
      # NOTE: Toolchain cache save disabled (restore also disabled above)
      # - name: Save toolchain cache
      #   if: steps.toolchain-cache.outputs.cache-hit != 'true'
      #   uses: actions/cache/save@v4
      #   with:
      #     path: |
      #       subverso/.lake
      #       LeanArchitect/.lake
      #       Dress/.lake
      #       Runway/.lake
      #     key: toolchain-build-${{ runner.os }}-${{ env.LEAN_VERSION }}-${{ hashFiles('SBS-Test/lean-toolchain') }}

      - name: Save mathlib cache
        if: steps.mathlib-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: SBS-Test/.lake/packages/mathlib
          key: mathlib-${{ runner.os }}-${{ hashFiles('SBS-Test/lake-manifest.json') }}

      # ========================================
      # UPLOAD: Pages artifact
      # ========================================
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: SBS-Test/.lake/build/runway

  # ========================================
  # DEPLOY: GitHub Pages
  # ========================================
  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
